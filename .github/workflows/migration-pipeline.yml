name: Liquibase Migration Pipeline

on:
  push:
    branches: [ main ]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment: dev

    # Add MySQL service container for testing (if DEV_DB_URL secret is not set)
    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: admin
          MYSQL_DATABASE: testdb_dev
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping -h localhost"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=3

    steps:
      - name: ✅ Checkout Code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: ✅ Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: ✅ Install Liquibase & MySQL Client
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y mysql-client unzip
          
          # Download and install Liquibase
          curl -sLo liquibase.zip https://github.com/liquibase/liquibase/releases/download/v4.33.0/liquibase-4.33.0.zip
          unzip -q liquibase.zip -d $HOME/liquibase
          
          # Download MySQL connector JAR (required for MySQL connections)
          curl -sLo $HOME/liquibase/lib/mysql-connector-j.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.1.0/mysql-connector-j-9.1.0.jar
          
          # Add Liquibase to PATH
          echo "$HOME/liquibase" >> $GITHUB_PATH

      - name: ✅ Verify Changelog File Exists
        run: |
          ls -la backend/changelogs/
          test -f backend/changelogs/master-changelog.xml || (echo "ERROR: master-changelog.xml not found!" && exit 1)

      - name: ✅ Show Pending Changes (DEV)
        env:
          # Use secret if available, otherwise use service container
          DEV_DB_URL: ${{ secrets.DEV_DB_URL != '' && secrets.DEV_DB_URL || 'jdbc:mysql://localhost:3306/testdb_dev?user=root&password=admin' }}
        run: |
          liquibase \
            --url="$DEV_DB_URL" \
            --changeLogFile=master-changelog.xml \
            --searchPath=backend/changelogs \
            status

      - name: ✅ Deploy to DEV
        env:
          # Use secret if available, otherwise use service container
          DEV_DB_URL: ${{ secrets.DEV_DB_URL != '' && secrets.DEV_DB_URL || 'jdbc:mysql://localhost:3306/testdb_dev?user=root&password=admin' }}
        run: |
          liquibase \
            --url="$DEV_DB_URL" \
            --changeLogFile=master-changelog.xml \
            --searchPath=backend/changelogs \
            update

      - name: ✅ Smoke Test
        env:
          DB_HOST: ${{ secrets.DB_HOST != '' && secrets.DB_HOST || 'localhost' }}
          DB_USER: ${{ secrets.DB_USER != '' && secrets.DB_USER || 'root' }}
          DB_PASS: ${{ secrets.DB_PASS != '' && secrets.DB_PASS || 'admin' }}
        run: mysql -h $DB_HOST -u $DB_USER -p$DB_PASS -e "SELECT 1"


  promote-to-qa:
    needs: deploy
    runs-on: ubuntu-latest
    environment: qa

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y unzip
          curl -sLo liquibase.zip https://github.com/liquibase/liquibase/releases/download/v4.33.0/liquibase-4.33.0.zip
          unzip -q liquibase.zip -d $HOME/liquibase
          curl -sLo $HOME/liquibase/lib/mysql-connector-j.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.1.0/mysql-connector-j-9.1.0.jar
          echo "$HOME/liquibase" >> $GITHUB_PATH

      - name: Deploy to QA
        run: |
          liquibase \
            --url="${{ secrets.QA_DB_URL }}" \
            --changeLogFile=master-changelog.xml \
            --searchPath=backend/changelogs \
            update


  promote-to-prod:
    needs: promote-to-qa
    runs-on: ubuntu-latest
    environment: prod

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          ref: ${{ github.ref }}

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase
        run: |
          set -e
          sudo apt-get update
          sudo apt-get install -y unzip
          curl -sLo liquibase.zip https://github.com/liquibase/liquibase/releases/download/v4.33.0/liquibase-4.33.0.zip
          unzip -q liquibase.zip -d $HOME/liquibase
          curl -sLo $HOME/liquibase/lib/mysql-connector-j.jar https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/9.1.0/mysql-connector-j-9.1.0.jar
          echo "$HOME/liquibase" >> $GITHUB_PATH

      - name: Deploy to PROD
        run: |
          liquibase \
            --url="${{ secrets.PROD_DB_URL }}" \
            --changeLogFile=master-changelog.xml \
            --searchPath=backend/changelogs \
            update
