name: Liquibase Railway Pipeline

on:
  push:
    branches: [ "main" ]

  workflow_dispatch:
    inputs:
      environment:
        description: "Rollback environment"
        required: true
        type: choice
        options: [dev, qa, prod]

      count:
        description: "Rollback count"
        required: true
        default: "1"

env:
  LB_VERSION: 4.33.0
  MYSQL_VERSION: 9.1.0

# =====================================================
# COMMON SETUP
# =====================================================

defaults:
  run:
    shell: bash


# =====================================================
# DEV
# =====================================================

jobs:

  deploy-dev:
    name: Deploy DEV
    runs-on: ubuntu-latest
    environment: dev

    steps:

      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17

      - name: Install Liquibase
        run: |
          curl -sLo lb.zip \
          https://github.com/liquibase/liquibase/releases/download/v${LB_VERSION}/liquibase-${LB_VERSION}.zip

          unzip -q lb.zip -d $HOME/liquibase
          chmod +x $HOME/liquibase/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH

          mkdir -p $HOME/liquibase/lib

          curl -sLo $HOME/liquibase/lib/mysql.jar \
          https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_VERSION}/mysql-connector-j-${MYSQL_VERSION}.jar


      - name: Validate DEV
        run: |
          liquibase \
            --url="${{ secrets.DEV_DB_URL }}" \
            --changeLogFile=master-changelog.xml \
            --searchPath="$GITHUB_WORKSPACE/backend/changelogs" \
            --classpath="$HOME/liquibase/lib/mysql.jar" \
            validate


      - name: Deploy DEV
        run: |
          liquibase \
            --url="${{ secrets.DEV_DB_URL }}" \
            --changeLogFile=master-changelog.xml \
            --searchPath="$GITHUB_WORKSPACE/backend/changelogs" \
            --classpath="$HOME/liquibase/lib/mysql.jar" \
            update


# =====================================================
# QA (Manual Approval)
# =====================================================

  deploy-qa:
    name: Deploy QA
    needs: deploy-dev
    runs-on: ubuntu-latest
    environment: qa

    steps:

      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17


      - name: Install Liquibase
        run: |
          curl -sLo lb.zip \
          https://github.com/liquibase/liquibase/releases/download/v${LB_VERSION}/liquibase-${LB_VERSION}.zip

          unzip -q lb.zip -d $HOME/liquibase
          chmod +x $HOME/liquibase/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH

          mkdir -p $HOME/liquibase/lib

          curl -sLo $HOME/liquibase/lib/mysql.jar \
          https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_VERSION}/mysql-connector-j-${MYSQL_VERSION}.jar


      - name: Deploy QA
        run: |
          liquibase \
            --url="${{ secrets.QA_DB_URL }}" \
            --changeLogFile=master-changelog.xml \
            --searchPath="$GITHUB_WORKSPACE/backend/changelogs" \
            --classpath="$HOME/liquibase/lib/mysql.jar" \
            update


# =====================================================
# PROD (Manual Approval)
# =====================================================

  deploy-prod:
    name: Deploy PROD
    needs: deploy-qa
    runs-on: ubuntu-latest
    environment: prod

    steps:

      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17


      - name: Install Liquibase
        run: |
          curl -sLo lb.zip \
          https://github.com/liquibase/liquibase/releases/download/v${LB_VERSION}/liquibase-${LB_VERSION}.zip

          unzip -q lb.zip -d $HOME/liquibase
          chmod +x $HOME/liquibase/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH

          mkdir -p $HOME/liquibase/lib

          curl -sLo $HOME/liquibase/lib/mysql.jar \
          https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_VERSION}/mysql-connector-j-${MYSQL_VERSION}.jar


      - name: Deploy PROD
        run: |
          liquibase \
            --url="${{ secrets.PROD_DB_URL }}" \
            --changeLogFile=master-changelog.xml \
            --searchPath="$GITHUB_WORKSPACE/backend/changelogs" \
            --classpath="$HOME/liquibase/lib/mysql.jar" \
            update


# =====================================================
# ROLLBACK
# =====================================================

  rollback:
    name: Rollback
    if: github.event_name == 'workflow_dispatch'
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4

      - uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17


      - name: Install Liquibase
        run: |
          curl -sLo lb.zip \
          https://github.com/liquibase/liquibase/releases/download/v${LB_VERSION}/liquibase-${LB_VERSION}.zip

          unzip -q lb.zip -d $HOME/liquibase
          chmod +x $HOME/liquibase/liquibase
          echo "$HOME/liquibase" >> $GITHUB_PATH

          mkdir -p $HOME/liquibase/lib

          curl -sLo $HOME/liquibase/lib/mysql.jar \
          https://repo1.maven.org/maven2/com/mysql/mysql-connector-j/${MYSQL_VERSION}/mysql-connector-j-${MYSQL_VERSION}.jar


      - name: Rollback
        run: |
          if [ "${{ github.event.inputs.environment }}" = "dev" ]; then
            DB="${{ secrets.DEV_DB_URL }}"
          elif [ "${{ github.event.inputs.environment }}" = "qa" ]; then
            DB="${{ secrets.QA_DB_URL }}"
          else
            DB="${{ secrets.PROD_DB_URL }}"
          fi

          liquibase \
            --url="$DB" \
            --changeLogFile=master-changelog.xml \
            --searchPath="$GITHUB_WORKSPACE/backend/changelogs" \
            --classpath="$HOME/liquibase/lib/mysql.jar" \
            rollback-count ${{ github.event.inputs.count }}